<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Asciidoctor, documentation from the undead (code)</title><meta name="generator" content="Asciidoctor 1.5.5 (Bespoke.js converter)"><meta name="mobile-web-app-capable" content="yes"><link rel="stylesheet" href="build/build.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.0/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css"></head><body><article class="deck"><section class="title" data-title=""><h1>Asciidoctor, documentation from the undead (code)</h1><p><span class="bigIcon"><span class="icon"><i class="fa fa-code-fork"></i></span></span></p>
<pre><code>           .                         .
   ___. ` _/_           __.    ___  _/_     __.  \,___, ,   .   ____
 .'   ` |  |    .---' .'   \ .'   `  |    .'   \ |    \ |   |  (
 |    | |  |          |    | |       |    |    | |    | |   |  `--.
  `---| /  \__/        `._.'  `._.'  \__/  `._.' |`---' `._/| \___.'
  \___/                                          \

                    ease deployment and testing</code></pre></section>
<section><h2>Problem to solve</h2><ul><li><span class="primary">multiple branches</span></li><li><span class="primary">need to test them quickly</span></li><li><span class="primary">without deploying on multiple host</span></li><li><span class="primary">detect conflicts early</span></li></ul></section>
<section><h2>Solution</h2><ul><li><span class="primary">flatten all branches to a temporary one</span></li><li><span class="primary">deploy the result to allow testing</span></li></ul></section>
<section><h2>Tools</h2><ul><li><span class="primary"><a href="https://github.com/lesfurets/git-octopus">git-octopus</a> by LesFurets</span></li><li><span class="primary">Jenkins</span></li></ul></section>
<section><h2>Process</h2><ul><li><span class="primary">Every developer work on his branches</span></li><li><span class="primary">Normalize naming relative to issues (<code>fix/XXX-123</code> or <code>feature/XXX-456</code>)</span></li><li><span class="primary">Manually trigger the octopus deploy (for the time being)</span></li></ul></section>
<section><h2>Results</h2><div class="two-columns center"><figure class="image"><img src="./images/octopus_merge_graph.png" alt="octopus merge graph"></figure>
<p class="left-content">A meta branch containing everything flattened on top of your <code>master</code> branch.</p></div></section>
<section><h2>Tooling</h2><pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">stage('Run octopus merge on specified branches') {
	//see install guide on http://linuxbrew.sh, then brew install git-octopus
	env.PATH = "/home/jenkins/.linuxbrew/bin/:${env.PATH}" <i class="conum" data-value="1"></i><b>(1)</b>
	sh "git octopus ${BRANCH_TO_MERGE} origin/master" <i class="conum" data-value="2"></i><b>(2)</b>
}
stage('Push octopus to bitbucket') {
	sshagent([credentialId]) {
		sh 'git push origin +HEAD:refs/heads/octopus'
	}
}</code></pre>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>git-octopus</code> has been installed with <a href="http://linuxbrew.sh"><code>linuxbrew</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We trigger the merge of a build parameter (<code>*/PR-*</code> by default)</td>
</tr>
</table>
</div></section>
<section><h2>Deploying</h2><pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">stage("Deploy octopus on ${name}") {
	build job: 'Project - build branch and deploy',  <i class="conum" data-value="1"></i><b>(1)</b>
           parameters: [
		[$class: 'StringParameterValue',
               name: 'BRANCH_TO_BUILD', value: 'octopus'], <i class="conum" data-value="2"></i><b>(2)</b>
		[$class: 'StringParameterValue',
               name: 'NODE_TO_DEPLOY', value: machine] <i class="conum" data-value="3"></i><b>(3)</b>
	]
}</code></pre>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Building app job</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parameter specifiying the branch to build</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The target machine as a parameter</td>
</tr>
</table>
</div></section>
<section><h2>Conflicts ?</h2><ul><li><span class="primary">can they be resolved automatically ?</span></li><li><span class="primary">feature branch not merging cleanly with <code>master</code> branch ?</span></li><li><span class="primary">feature branches not merging cleanly with each other ?</span></li></ul></section>
<section><h2>Automatic resolution</h2><pre><code>Simple merge did not work, trying automatic merge.
Auto-merging src/main/groovy/MyClass.groovy</code></pre></section>
<section><h2>Conflict with <code>master</code> branch</h2><pre><code>Testing merges one by one with 11ad91...

merging refs/remotes/origin/feature/PRJ-160 ... FAILURE</code></pre></section>
<section><h2>Work on your machine</h2><pre class="source"><code data-lang="shell" class="language-shell prettyprint">git checkout feature/PRJ-160
git merge origin/master
# resolve conflicts
git push -u origin feature/PRJ-160</code></pre></section>
<section><h2>Conflict between two parallel branches</h2><pre><code>Trying simple merge with refs/remotes/origin/fix/PRJ-100
Trying simple merge with refs/remotes/origin/fix/PRJ-200
Simple merge did not work, trying automatic merge.
Auto-merging src/main/groovy/MyClass.groovy
ERROR: content conflict in src/main/groovy/MyClass.groovy
fatal: merge program failed
Automated merge did not work.</code></pre></section>
<section><h2>Work on your machine</h2><pre class="source"><code data-lang="shell" class="language-shell prettyprint">git checkout feature/PRJ-100 <i class="conum" data-value="1"></i><b>(1)</b>
git conflict feature/PRJ-200 <i class="conum" data-value="2"></i><b>(2)</b>
# resolve conflict
git add <i class="conum" data-value="3"></i><b>(3)</b>
git conflict --continue <i class="conum" data-value="4"></i><b>(4)</b>
git push origin refs/conflicts/d4d093 <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Checkout the branch that does not merge cleanly with another</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mark a conflict with the other branch</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Resolve the conflict using your preferred tool</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Save the resolution</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Push it to remote to allow Jenkins to catch it later</td>
</tr>
</table>
</div></section>
<section><h2>Result on CI</h2><pre><code>Trying simple merge with refs/remotes/origin/fix/PRJ-100
Trying simple merge with refs/remotes/origin/fix/PRJ-200
Simple merge did not work, trying automatic merge.
Auto-merging src/main/groovy/MyClass.groovy
ERROR: content conflict in src/main/groovy/MyClass.groovy
fatal: merge program failed
Applying conflict resolution d4d093</code></pre></section>
<section><h2>The thing that makes everything work</h2><pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">refspec: '+refs/heads/*:refs/remotes/origin/* ' +
    '+refs/conflicts/*:refs/conflicts/*' <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This tells to fetch <code>conflict</code> refs too</td>
</tr>
</table>
</div></section>
<section><h2>Results</h2><ul><li><span class="primary">snapshot of all deployments available</span></li><li><span class="primary">allow conflict resolution at an early stage</span></li></ul></section></article><script src="build/build.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script><script>Array.prototype.forEach.call(document.querySelectorAll('i.conum+b'),function(n){n.parentNode.removeChild(n)})</script><script>prettyPrint()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  }
})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script></body></html>
